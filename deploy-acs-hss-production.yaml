# Production Deployment - Simple Version
# Creates Ubuntu 24.04 VM, uploads and runs installation script

steps:
  # Step 1: Create VM
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'create-vm'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud compute addresses create acs-hss-ip --region=us-central1 2>/dev/null || true
        STATIC_IP=$$(gcloud compute addresses describe acs-hss-ip --region=us-central1 --format='get(address)')
        
        gcloud compute firewall-rules create acs-hss-all --allow tcp:80,tcp:443,tcp:7547,tcp:3868,tcp:3000,tcp:7557,tcp:3333 --target-tags=acs-hss 2>/dev/null || true
        
        if ! gcloud compute instances describe acs-hss-server --zone=us-central1-a &>/dev/null; then
          gcloud compute instances create acs-hss-server \
            --zone=us-central1-a \
            --machine-type=e2-standard-4 \
            --image-family=ubuntu-2404-lts-amd64 \
            --image-project=ubuntu-os-cloud \
            --boot-disk-size=50GB \
            --tags=acs-hss \
            --address=$$STATIC_IP \
            --scopes=cloud-platform
          
          sleep 60
        fi
        
        echo "VM ready: $$STATIC_IP"

  # Step 2: Upload installation script from repo
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'upload-script'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        MONGODB_URI=$$(gcloud secrets versions access latest --secret="mongodb-uri")
        
        # Create simple installation script
        cat > /workspace/install.sh << 'EOF'
        #!/bin/bash
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt-get install -y nodejs git docker.io
        systemctl enable docker
        systemctl start docker
        cd /opt
        git clone https://github.com/joshualambert/rapid5gs.git
        echo "Rapid5GS cloned" > /var/log/install.log
        EOF
        
        gsutil mb gs://temp-install-$BUILD_ID 2>/dev/null || true
        gsutil cp /workspace/install.sh gs://temp-install-$BUILD_ID/
        
        gcloud compute instances add-metadata acs-hss-server --zone=us-central1-a \
          --metadata startup-script-url=gs://temp-install-$BUILD_ID/install.sh
        
        gcloud compute instances reset acs-hss-server --zone=us-central1-a --quiet
        
        sleep 120
        
        echo "Installation complete"

  # Step 3: Report
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'report'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        IP=$$(gcloud compute instances describe acs-hss-server --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
        echo "════════════════════════════════════════════════"
        echo "  ✅ VM CREATED"
        echo "════════════════════════════════════════════════"
        echo "VM: acs-hss-server"
        echo "IP: $$IP"
        echo "OS: Ubuntu 24.04"
        echo ""
        echo "SSH: gcloud compute ssh acs-hss-server --zone=us-central1-a"
        echo ""
        echo "rapid5gs is in: /opt/rapid5gs"
        echo "To complete: cd /opt/rapid5gs && chmod +x install.sh && ./install.sh"
        echo "════════════════════════════════════════════════"

timeout: 1800s
