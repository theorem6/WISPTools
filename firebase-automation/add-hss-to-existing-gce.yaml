# Add HSS to Existing GCE Instance (No SSH, No New Instance)
# Deploys HSS module to your existing genieacs-backend instance
# Works from Firebase Studio

steps:
  # Step 1: Verify existing instance
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-instance'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if ! gcloud compute instances describe genieacs-backend --zone=us-central1-a &>/dev/null; then
          echo "âŒ Error: Instance genieacs-backend not found"
          echo "   Please create the instance first or check the instance name"
          exit 1
        fi
        
        echo "âœ… Found existing instance: genieacs-backend"
        
        # Get external IP
        EXTERNAL_IP=$(gcloud compute instances describe genieacs-backend --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
        echo "   External IP: $EXTERNAL_IP"
        echo "$EXTERNAL_IP" > /workspace/external-ip.txt

  # Step 2: Add firewall rules for HSS (if not exist)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'add-firewall-rules'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ”¥ Adding HSS firewall rules..."
        
        # HSS REST API (port 3000)
        gcloud compute firewall-rules create allow-hss-api \
          --allow tcp:3000 \
          --target-tags=acs-server \
          --description="HSS REST API" 2>/dev/null || echo "  âœ“ allow-hss-api already exists"
        
        # HSS S6a Diameter (port 3868)
        gcloud compute firewall-rules create allow-hss-s6a \
          --allow tcp:3868 \
          --target-tags=acs-server \
          --description="HSS S6a Diameter interface for MME connections" 2>/dev/null || echo "  âœ“ allow-hss-s6a already exists"
        
        echo "âœ… Firewall rules configured"

  # Step 3: Package HSS module and upload to Cloud Storage
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'package-hss'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“¦ Packaging HSS module..."
        
        # Create bucket for deployment
        gsutil mb -p lte-pci-mapper-65450042-bbf71 gs://hss-deploy-${BUILD_ID} 2>/dev/null || true
        
        # Package HSS module
        cd hss-module
        tar -czf /workspace/hss-module.tar.gz .
        cd ..
        
        # Upload to Cloud Storage
        gsutil cp /workspace/hss-module.tar.gz gs://hss-deploy-${BUILD_ID}/hss-module.tar.gz
        
        echo "âœ… HSS module packaged and uploaded"

  # Step 4: Create deployment script
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'create-deployment-script'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“ Creating deployment script..."
        
        # Get secrets
        MONGODB_URI=$(gcloud secrets versions access latest --secret="mongodb-uri")
        HSS_KEY=$(gcloud secrets versions access latest --secret="hss-encryption-key")
        
        # Create comprehensive deployment script
        cat > /tmp/deploy-hss-full.sh << 'DEPLOY'
#!/bin/bash
set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ðŸš€ Adding HSS to Existing ACS Server"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Download HSS module
echo "ðŸ“¥ Downloading HSS module..."
cd /tmp
gsutil cp gs://hss-deploy-*/hss-module.tar.gz ./

# Setup directory
echo "ðŸ“‚ Setting up HSS directory..."
mkdir -p /opt/hss-server
tar -xzf hss-module.tar.gz -C /opt/hss-server/

# Install dependencies
echo "ðŸ“¦ Installing dependencies..."
cd /opt/hss-server
npm install --production --silent
npm install milenage mongodb express cors --silent

# Create config file
echo "âš™ï¸  Creating configuration..."
cat > /opt/hss-server/config.json << 'CONFIG'
{
  "server": {
    "host": "0.0.0.0",
    "rest_api_port": 3000,
    "s6a_port": 3868
  },
  "diameter": {
    "realm": "lte-pci-mapper.com",
    "identity": "hss.lte-pci-mapper.com",
    "vendor_id": 10415
  },
  "mongodb": {
    "uri": "MONGODB_URI_PLACEHOLDER",
    "database": "hss"
  },
  "acs_integration": {
    "enabled": true,
    "sync_interval_minutes": 5,
    "genieacs_mongodb_uri": "MONGODB_URI_PLACEHOLDER",
    "genieacs_database": "genieacs"
  },
  "features": {
    "capture_imei": true,
    "track_sessions": true,
    "audit_logging": true
  }
}
CONFIG

# Replace placeholders with actual values
sed -i "s|MONGODB_URI_PLACEHOLDER|${MONGODB_URI}|g" /opt/hss-server/config.json

# Initialize database
echo "ðŸ—„ï¸  Initializing HSS database..."
export MONGODB_URI="${MONGODB_URI}"
export HSS_ENCRYPTION_KEY="${HSS_KEY}"
cd /opt/hss-server
node scripts/init-database.js 2>/dev/null || echo "  âœ“ Database already initialized"

# Create systemd service
echo "âš™ï¸  Creating HSS systemd service..."
cat > /etc/systemd/system/hss.service << 'SERVICE'
[Unit]
Description=Cloud HSS Server
After=network.target docker.service

[Service]
Type=simple
WorkingDirectory=/opt/hss-server
Environment="NODE_ENV=production"
Environment="HSS_ENCRYPTION_KEY=HSS_KEY_PLACEHOLDER"
Environment="MONGODB_URI=MONGODB_URI_PLACEHOLDER"
ExecStart=/usr/bin/node /opt/hss-server/server.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
SERVICE

# Replace placeholders
sed -i "s|HSS_KEY_PLACEHOLDER|${HSS_KEY}|g" /etc/systemd/system/hss.service
sed -i "s|MONGODB_URI_PLACEHOLDER|${MONGODB_URI}|g" /etc/systemd/system/hss.service

# Start HSS service
echo "ðŸš€ Starting HSS service..."
systemctl daemon-reload
systemctl enable hss
systemctl restart hss

# Wait for HSS to start
sleep 5

# Check HSS status
if systemctl is-active --quiet hss; then
  echo "âœ… HSS service is running"
else
  echo "âš ï¸  HSS service may not be running, check logs"
  journalctl -u hss -n 20
fi

# Update Nginx configuration (add HSS routes)
echo "âš™ï¸  Updating Nginx configuration..."
if [ ! -f /etc/nginx/sites-available/acs-hss-updated ]; then
  cat > /etc/nginx/sites-available/acs-hss << 'NGINXCONF'
server {
    listen 80 default_server;
    server_name _;
    client_max_body_size 100M;
    
    # HSS REST API
    location /api/hss/ {
        proxy_pass http://localhost:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
    
    # GenieACS NBI API (existing)
    location /nbi/ {
        proxy_pass http://localhost:7557/;
        proxy_set_header Host \$host;
    }
    
    # GenieACS File Server (existing)
    location /fs/ {
        proxy_pass http://localhost:7567/;
        client_max_body_size 500M;
    }
    
    # GenieACS UI (existing)
    location /admin/ {
        proxy_pass http://localhost:3333/;
    }
    
    # Existing backend API (if any)
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host \$host;
    }
    
    # Health check
    location /health {
        access_log off;
        return 200 'healthy';
        add_header Content-Type text/plain;
    }
}
NGINXCONF

  # Enable site
  ln -sf /etc/nginx/sites-available/acs-hss /etc/nginx/sites-enabled/
  rm -f /etc/nginx/sites-enabled/default
  
  # Test and reload
  nginx -t && systemctl reload nginx
  
  touch /etc/nginx/sites-available/acs-hss-updated
  echo "âœ… Nginx updated"
else
  echo "  âœ“ Nginx already configured"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… HSS INSTALLATION COMPLETE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Services Status:"
systemctl status hss --no-pager | head -5
echo ""
echo "Test HSS:"
echo "  curl http://localhost:3000/health"
curl -s http://localhost:3000/health || echo "HSS not responding yet"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Mark completion
echo "$(date): HSS deployed successfully" >> /var/log/hss-deployment.log
DEPLOY

        # Replace placeholders in deployment script
        sed -i "s|MONGODB_URI_PLACEHOLDER|${MONGODB_URI}|g" /tmp/deploy-hss-full.sh
        sed -i "s|HSS_KEY_PLACEHOLDER|${HSS_KEY}|g" /tmp/deploy-hss-full.sh
        
        # Upload deployment script
        gsutil cp /tmp/deploy-hss-full.sh gs://hss-deploy-${BUILD_ID}/deploy-hss-full.sh
        
        echo "âœ… Deployment script created"

  # Step 5: Execute deployment via instance metadata
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'execute-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸš€ Executing deployment on existing instance..."
        
        # Download and execute deployment script using startup-script
        SCRIPT_URL="gs://hss-deploy-${BUILD_ID}/deploy-hss-full.sh"
        
        gcloud compute instances add-metadata genieacs-backend --zone=us-central1-a \
          --metadata startup-script-url="${SCRIPT_URL}"
        
        # Trigger script execution by resetting instance
        echo "Restarting instance to run deployment..."
        gcloud compute instances reset genieacs-backend --zone=us-central1-a --quiet
        
        # Wait for instance to come back online and deploy
        echo "Waiting for deployment to complete (this takes ~3 minutes)..."
        sleep 180
        
        echo "âœ… Deployment executed"

  # Step 6: Verify and report
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-and-cleanup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        EXTERNAL_IP=$(gcloud compute instances describe genieacs-backend --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ… HSS ADDED TO EXISTING ACS SERVER"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸŒ External IP: $EXTERNAL_IP"
        echo ""
        echo "ðŸ“¡ Your Services:"
        echo "   HSS REST API:     http://$EXTERNAL_IP/api/hss/"
        echo "   HSS S6a:          $EXTERNAL_IP:3868"
        echo "   GenieACS NBI:     http://$EXTERNAL_IP/nbi/ (existing)"
        echo "   GenieACS CWMP:    http://$EXTERNAL_IP:7547 (existing)"
        echo "   GenieACS UI:      http://$EXTERNAL_IP/admin/ (existing)"
        echo "   Health Check:     http://$EXTERNAL_IP/health"
        echo ""
        echo "ðŸ§ª Test HSS API:"
        echo "   curl http://$EXTERNAL_IP/api/hss/health"
        echo ""
        echo "ðŸ“ Next Steps:"
        echo "   1. Test: curl http://$EXTERNAL_IP/health"
        echo "   2. View in Compute Engine console"
        echo "   3. Initialize sample data (see init-hss-sample-data.sh)"
        echo "   4. Open web UI: https://lte-pci-mapper-65450042-bbf71.web.app"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Cleanup temporary storage
        gsutil -m rm -r gs://hss-deploy-${BUILD_ID} 2>/dev/null || true
        
        echo ""
        echo "âœ… Deployment complete and verified"

timeout: 3600s
options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

