# Add HSS to Existing GCE Instance
# Simple deployment without SSH

steps:
  # Step 1: Verify instance exists
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-instance'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if ! gcloud compute instances describe genieacs-backend --zone=us-central1-a &>/dev/null; then
          echo "❌ Error: Instance genieacs-backend not found"
          exit 1
        fi
        echo "✅ Found existing instance: genieacs-backend"
        EXTERNAL_IP=$(gcloud compute instances describe genieacs-backend --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
        echo "   External IP: $EXTERNAL_IP"

  # Step 2: Add firewall rules
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'add-firewall-rules'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud compute firewall-rules create allow-hss-api --allow tcp:3000 --target-tags=acs-server 2>/dev/null || echo "✓ Firewall rule exists"
        gcloud compute firewall-rules create allow-hss-s6a --allow tcp:3868 --target-tags=acs-server 2>/dev/null || echo "✓ Firewall rule exists"
        echo "✅ Firewall configured"

  # Step 3: Package and upload HSS
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'upload-hss'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gsutil mb -p lte-pci-mapper-65450042-bbf71 gs://hss-deploy-${BUILD_ID} 2>/dev/null || true
        cd hss-module && tar -czf /workspace/hss-module.tar.gz . && cd ..
        gsutil cp /workspace/hss-module.tar.gz gs://hss-deploy-${BUILD_ID}/
        echo "✅ HSS packaged"

  # Step 4: Create deployment script
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'create-script'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        MONGODB_URI=$(gcloud secrets versions access latest --secret="mongodb-uri")
        HSS_KEY=$(gcloud secrets versions access latest --secret="hss-encryption-key")
        
        cat > /workspace/deploy.sh << 'EOF'
        #!/bin/bash
        set -ex
        cd /tmp
        gsutil cp gs://hss-deploy-*/hss-module.tar.gz ./
        mkdir -p /opt/hss-server
        tar -xzf hss-module.tar.gz -C /opt/hss-server/
        cd /opt/hss-server
        npm install --production
        npm install milenage mongodb express cors
        EOF
        
        cat >> /workspace/deploy.sh << EOF
        cat > /opt/hss-server/config.json << 'CONF'
        {"server":{"host":"0.0.0.0","rest_api_port":3000,"s6a_port":3868},"diameter":{"realm":"lte-pci-mapper.com","identity":"hss.lte-pci-mapper.com"},"mongodb":{"uri":"${MONGODB_URI}","database":"hss"},"acs_integration":{"enabled":true,"sync_interval_minutes":5}}
        CONF
        export MONGODB_URI='${MONGODB_URI}'
        export HSS_ENCRYPTION_KEY='${HSS_KEY}'
        node scripts/init-database.js || true
        cat > /etc/systemd/system/hss.service << 'SVC'
        [Unit]
        Description=HSS Server
        After=network.target
        [Service]
        WorkingDirectory=/opt/hss-server
        Environment="HSS_ENCRYPTION_KEY=${HSS_KEY}"
        Environment="MONGODB_URI=${MONGODB_URI}"
        ExecStart=/usr/bin/node server.js
        Restart=always
        [Install]
        WantedBy=multi-user.target
        SVC
        systemctl daemon-reload
        systemctl enable hss
        systemctl restart hss
        sleep 3
        systemctl status hss
        echo "HSS deployed" > /var/log/hss-deployed.log
        EOF
        
        gsutil cp /workspace/deploy.sh gs://hss-deploy-${BUILD_ID}/deploy.sh
        echo "✅ Script created"

  # Step 5: Execute deployment
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud compute instances add-metadata genieacs-backend --zone=us-central1-a \
          --metadata startup-script-url=gs://hss-deploy-${BUILD_ID}/deploy.sh
        gcloud compute instances reset genieacs-backend --zone=us-central1-a --quiet
        echo "⏳ Waiting for deployment (180 seconds)..."
        sleep 180
        echo "✅ Deployment complete"

  # Step 6: Verify
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        EXTERNAL_IP=$(gcloud compute instances describe genieacs-backend --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
        echo ""
        echo "════════════════════════════════════════════════"
        echo "  ✅ HSS DEPLOYED"
        echo "════════════════════════════════════════════════"
        echo "IP: $EXTERNAL_IP"
        echo "HSS API: http://$EXTERNAL_IP/api/hss/"
        echo "Test: curl http://$EXTERNAL_IP/api/hss/health"
        echo "════════════════════════════════════════════════"
        gsutil -m rm -r gs://hss-deploy-${BUILD_ID} 2>/dev/null || true

timeout: 1800s
